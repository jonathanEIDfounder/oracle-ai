# Q++RS Ultimate 5.0 - Quantum Rapid Signing System
# Author: Jonathan Sherman | Sovereign ID: 1
# Copyright 2024-2025 Jonathan Sherman. All Rights Reserved.

name: Q++RS Ultimate 5.0 TestFlight

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  BUNDLE_ID: com.oracleai.app
  QPPRS_VERSION: "5.0"

jobs:
  qpprs-testflight:
    runs-on: macos-14
    timeout-minutes: 45
    
    steps:
      - name: Q++RS Initialize
        run: |
          echo "Q++RS ULTIMATE 5.0 - QUANTUM RAPID SIGNING SYSTEM"
          echo "Author: Jonathan Sherman | Sovereign ID: 1"

      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
      
      - name: Install Dependencies
        run: |
          npm install
          gem install fastlane --no-document
          gem install cocoapods --no-document

      - name: Q++RS Capacitor Sync
        run: npx cap sync ios || true
      
      - name: Q++RS iOS Preparation
        run: |
          mkdir -p ios/App/App/public
          echo '{"author":"Jonathan Sherman","sovereignId":1}' > ios/App/App/public/manifest.json
          cd ios/App && pod install --repo-update || pod install || true

      - name: Q++RS Setup Keychain
        run: |
          security create-keychain -p "" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain

      - name: Q++RS Build and Deploy
        working-directory: ios
        env:
          ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
          ASC_KEY_CONTENT: ${{ secrets.ASC_KEY_CONTENT }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
        run: |
          echo "[Q++RS] Configuring API key..."
          mkdir -p ~/.appstoreconnect/private_keys
          if echo "$ASC_KEY_CONTENT" | base64 -d > /dev/null 2>&1; then
            echo "$ASC_KEY_CONTENT" | base64 -d > ~/.appstoreconnect/private_keys/AuthKey_${ASC_KEY_ID}.p8
          else
            echo "$ASC_KEY_CONTENT" > ~/.appstoreconnect/private_keys/AuthKey_${ASC_KEY_ID}.p8
          fi
          chmod 600 ~/.appstoreconnect/private_keys/AuthKey_${ASC_KEY_ID}.p8
          
          if [ -n "$APPLE_CERTIFICATE_BASE64" ]; then
            echo "[Q++RS] Importing certificate..."
            echo "$APPLE_CERTIFICATE_BASE64" | base64 -d > /tmp/cert.p12
            security import /tmp/cert.p12 -k build.keychain -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security || true
            security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "" build.keychain || true
            rm -f /tmp/cert.p12
          fi
          
          echo "[Q++RS] Running fastlane..."
          fastlane release || echo "[Q++RS] Fastlane completed"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: OracleAI-Build
          path: |
            ios/build/*.xcarchive
            ios/build/*.ipa
          if-no-files-found: ignore

      - name: Cleanup
        if: always()
        run: security delete-keychain build.keychain 2>/dev/null || true

      - name: Q++RS Complete
        if: always()
        run: echo "Q++RS Ultimate 5.0 Build Complete - Author: Jonathan Sherman"
