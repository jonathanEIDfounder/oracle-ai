# ═══════════════════════════════════════════════════════════════════════════════
# Q++RS ULTIMATE 5.0 - QUANTUM RAPID SIGNING SYSTEM
# ═══════════════════════════════════════════════════════════════════════════════
# Author: Jonathan Sherman
# Sovereign ID: 1
# Copyright (c) 2024-2025 Jonathan Sherman. All Rights Reserved.
# Signature: Sm9uYXRoYW4gU2hlcm1hbjo6U292ZXJlaWduOjoxOjpPcmFjbGVBSTo6USsrUlM=
# 
# AUTONOMOUS iOS SIGNING & TESTFLIGHT DEPLOYMENT
# Zero manual intervention - fully automated certificate management via match
# ═══════════════════════════════════════════════════════════════════════════════

default_platform(:ios)

QPPRS_VERSION = "5.0"
BUNDLE_ID = "com.oracleai.app"
AUTHOR = "Jonathan Sherman"
SOVEREIGN_ID = 1

platform :ios do
  before_all do
    puts ""
    puts "╔══════════════════════════════════════════════════════════════╗"
    puts "║     Q++RS ULTIMATE #{QPPRS_VERSION} - QUANTUM RAPID SIGNING SYSTEM       ║"
    puts "║                                                              ║"
    puts "║  Author: #{AUTHOR}                                    ║"
    puts "║  Sovereign ID: #{SOVEREIGN_ID}                                            ║"
    puts "║  Bundle: #{BUNDLE_ID}                              ║"
    puts "║  Mode: AUTONOMOUS SIGNING (match)                           ║"
    puts "╚══════════════════════════════════════════════════════════════╝"
    puts ""
    
    if ENV['CI']
      puts "[Q++RS] CI Environment detected - setting up keychain..."
      setup_ci
    end
  end

  desc "Q++RS Autonomous Build and TestFlight Upload"
  lane :release do
    puts "[Q++RS] Initializing App Store Connect API..."
    
    key_content = ENV["ASC_KEY_CONTENT"]
    is_base64 = !key_content.to_s.include?("-----BEGIN")
    
    api_key = app_store_connect_api_key(
      key_id: ENV["ASC_KEY_ID"],
      issuer_id: ENV["ASC_ISSUER_ID"],
      key_content: key_content,
      is_key_content_base64: is_base64
    )
    
    puts "[Q++RS] API Key authenticated successfully"
    puts "[Q++RS] Syncing certificates via match..."

    match(
      type: "appstore",
      app_identifier: BUNDLE_ID,
      api_key: api_key,
      readonly: is_ci,
      force_for_new_devices: true,
      verbose: true
    )
    
    puts "[Q++RS] Certificates synced"
    puts "[Q++RS] Building with Xcode..."

    increment_build_number(
      build_number: Time.now.strftime("%Y%m%d%H%M")
    )

    gym(
      workspace: "App/App.xcworkspace",
      scheme: "App",
      configuration: "Release",
      export_method: "app-store",
      output_directory: "build",
      output_name: "OracleAI.ipa",
      clean: true,
      xcargs: "-allowProvisioningUpdates",
      export_options: {
        signingStyle: "manual",
        uploadSymbols: true,
        compileBitcode: false,
        provisioningProfiles: {
          BUNDLE_ID => "match AppStore #{BUNDLE_ID}"
        }
      }
    )
    
    puts "[Q++RS] Build complete - uploading to TestFlight..."

    pilot(
      api_key: api_key,
      skip_waiting_for_build_processing: true,
      changelog: "Q++RS Ultimate #{QPPRS_VERSION} Build\nAuthor: #{AUTHOR}\nSovereign ID: #{SOVEREIGN_ID}\nDate: #{Time.now.strftime('%Y-%m-%d %H:%M UTC')}"
    )

    puts ""
    puts "╔══════════════════════════════════════════════════════════════╗"
    puts "║  Q++RS ULTIMATE #{QPPRS_VERSION} - BUILD & UPLOAD COMPLETE            ║"
    puts "║                                                              ║"
    puts "║  Status: SUCCESS                                             ║"
    puts "║  Destination: TestFlight                                     ║"
    puts "║  Author: #{AUTHOR}                                    ║"
    puts "╚══════════════════════════════════════════════════════════════╝"
    puts ""
  end

  desc "Q++RS Initialize Match Certificates (first-time setup)"
  lane :setup_certs do
    key_content = ENV["ASC_KEY_CONTENT"]
    is_base64 = !key_content.to_s.include?("-----BEGIN")
    
    api_key = app_store_connect_api_key(
      key_id: ENV["ASC_KEY_ID"],
      issuer_id: ENV["ASC_ISSUER_ID"],
      key_content: key_content,
      is_key_content_base64: is_base64
    )

    puts "[Q++RS] Creating distribution certificate..."
    match(
      type: "appstore",
      app_identifier: BUNDLE_ID,
      api_key: api_key,
      readonly: false,
      force: true
    )
    
    puts "[Q++RS] Certificates stored in match repository"
  end

  error do |lane, exception|
    puts ""
    puts "╔══════════════════════════════════════════════════════════════╗"
    puts "║  Q++RS ERROR - BUILD FAILED                                  ║"
    puts "╚══════════════════════════════════════════════════════════════╝"
    puts ""
    puts "Error: #{exception.message}"
    puts ""
  end
end
